// Generated by CoffeeScript 1.4.0
var app;

app = angular.module('unitguide', ['ngResource']);

app.controller('MainCtrl', function($scope, $resource, $filter) {
  var getFilterStats;
  $scope.pageSelect = function(v) {
    return $scope.selection = v;
  };
  $scope.selectedPage = "fac";
  $scope.pages = [
    {
      str: 'Factory Mode',
      key: 'fac'
    }, {
      str: 'Compare Mode',
      key: 'com'
    }
  ];
  $scope.unitStats = {
    health: {
      str: 'Health',
      active: true
    },
    cost: {
      str: 'Cost',
      active: true
    },
    damage: {
      str: 'Damage',
      active: false
    },
    dps: {
      str: 'DPS',
      active: true
    },
    dpspcost: {
      str: 'DPS / 1000 Metal',
      active: true
    },
    healthpcost: {
      str: 'Health / 1000 Metal',
      active: true
    },
    range: {
      str: 'Range',
      active: false
    },
    speed: {
      str: 'Speed',
      active: false
    },
    deathDmg: {
      str: 'Death Damage',
      active: false
    }
  };
  $scope.factories = $resource('../data/Factories.json').get(function() {
    return $scope.units = $resource('../data/Units.json').get(function() {
      var fac;
      if (typeof $scope.selectedPage !== void 0) {
        fac = $scope.factories.data[10];
        getFilterStats(fac.builds);
        return $scope.facPage.selectedFactory = fac;
      }
    });
  });
  $scope.facPage = {};
  $scope.facPage.unitSort = 'name';
  $scope.facPage.unitSeq = false;
  $scope.facPage.facSort = 'name';
  $scope.facPage.selectFactory = function() {
    var builds;
    builds = $scope.facPage.selectedFactory.builds;
    return getFilterStats(builds);
  };
  $scope.facPage.unitFilterByFac = function(units) {
    return function(u) {
      var makes;
      makes = units.indexOf(u.handle);
      return makes > -1;
    };
  };
  $scope.facPage.updateSortFields = function() {
    return angular.forEach($scope.unitStats, function(v, k) {
      if (v.active) {
        return $scope.facPage.sortFields[k] = v.str;
      } else {
        return delete $scope.facPage.sortFields[k];
      }
    });
  };
  $scope.facPage.sortFields = {};
  $scope.facPage.updateSortFields();
  $scope.facPage.unitSortCallback = function(sortBy) {
    if ($scope.facPage.unitSort === sortBy) {
      $scope.facPage.unitSeq = !$scope.facPage.unitSeq;
    }
    return $scope.facPage.unitSort = sortBy;
  };
  $scope.myWidth = function(stat, val) {
    var calc, max, min, perc;
    max = $scope.stats[stat].max;
    min = $scope.stats[stat].min;
    calc = 100 * Math.log(val) / Math.log(max);
    calc = calc * 2 - 120;
    perc = calc > 99 ? "100%" : Math.floor(calc) + "%";
    return perc;
  };
  getFilterStats = function(builds) {
    var stats, units;
    units = [];
    angular.forEach($scope.units.data, function(u) {
      var makes;
      makes = builds.indexOf(u.handle);
      if (makes > -1) {
        return units.push(u);
      }
    });
    stats = {};
    angular.forEach($scope.unitStats, function(t, k) {
      stats[k] = {
        'max': 0,
        'vals': []
      };
      angular.forEach(units, function(u) {
        return stats[k].vals.push(u[k]);
      });
      return stats[k].max = Math.max.apply(Math, stats[k].vals);
    });
    return $scope.stats = stats;
  };
  return console.log($scope);
});
